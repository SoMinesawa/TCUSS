# TCUSS (GrowSP only) configuration for nuScenes (10Hz subset aligned with VoteFlow preprocess)
#
# Workflow:
# 1) Convert nuScenes to PLY:
#    - edit `data_prepare/config_nuscenes_prepare.yaml` if needed
#    - run: `python data_prepare/data_prepare_nuScenes.py`
#
# 2) Build init superpoints:
#    - edit `data_prepare/config_initialSP_nuscenes.yaml` if needed
#    - run: `python data_prepare/initialSP_prepare_nuScenes.py`
#
# 3) Train (GrowSP only):
#    - run: `torchrun --nproc_per_node=<N> train_SemanticKITTI.py --config config/nuscenes_growsp.yaml`

# 基本設定
name: "nuscenes_growsp"
dataset: "nuscenes"

# 前処理済みPLY（data_prepare/data_prepare_nuScenes.py の output_path）
data_path: "data/users/minesawa/nuscenes/growsp"

# init superpoint（data_prepare/initialSP_prepare_nuScenes.py の sp_path）
sp_path: "data/users/minesawa/nuscenes/growsp_sp"

# nuScenes root (for future use / debug)
original_data_path: "data/dataset/nuscenes"

# unused for nuScenes (kept for config schema)
patchwork_path: "data/dataset/nuscenes"

# checkpoints / logs
save_path: "data/users/minesawa/nuscenes/nuscenes_growsp"

# pseudo labels (will be created)
pseudo_label_path: "pseudo_label_nuscenes/"

# (reserved for future STC) sp_mapping / sp_id outputs
sp_id_path: "sp_id_nuscenes/"

# エポック設定
max_epoch: [100, 350]
max_iter: [10000, 30000]

# モデル設定
bn_momentum: 0.02
conv1_kernel_size: 5

# 最適化設定
lr: 0.01
weight_decay: 0.01
accum_step: 1

# データロード設定
workers: 24
cluster_workers: 24
eval_workers: 24
batch_size: [16, 16]
eval_batch_size: 16
cluster_batch_size: 1

# DataLoader最適化
persistent_workers: false
prefetch_factor: 4

# マルチGPU設定
use_ddp: true
ddp_backend: "nccl"

# 実験設定
seed: 2022
log_interval: 1000000

# モデル構成設定
voxel_size: 0.15
input_dim: 3
primitive_num: 500
semantic_class: 16
feats_dim: 128
ignore_label: -1

# GrowSP設定
growsp:
  start: 80
  end: 30
  drop_threshold: 10
  w_rgb: 1.0
  c_rgb: 5.0
  c_shape: 5.0

# データセット設定
select_num: 1500
eval_select_num: 6019
r_crop: 50.0
frame_stride: 2  # nuScenesは20Hzなので、10Hzに合わせて1つ飛ばし
scan_window: 12  # 10Hzステップ（frame_stride後の隣接を1ステップとする）

# 評価設定
cluster_interval: 10
eval_interval: 10
silhouette: false

# 詳細評価設定
evaluation:
  distance_evaluation: true
  distance_bins: [10, 20, 30, 40, 50, 60, 70, 80]
  moving_static_evaluation: false  # nuScenesでは未使用

# 早期停止設定
early_stopping:
  enabled: false
  patience: 3
  min_delta: 0.15
  metric: "val_mIoU"
  mode: "max"
  rel_drop_window: 15
  overfit_drop: 0.30

# デバッグ設定
debug: false
vis: false
vis_sp: false

# 学習再開設定
resume: false
wandb_run_id: null

# STC（将来用。今は無効）
stc:
  enabled: false
  weight: 0.2
  voteflow_preprocess_path: "data/dataset/nuscenes/preprocess"
  sp_matching:
    weight_centroid_distance: 1.0
    weight_spread_similarity: 0.3
    weight_point_count_similarity: 0.2
    weight_remission_similarity: 0.0
    max_centroid_distance: 3.0
    min_score_threshold: 0.3
    min_sp_points: 10
    remove_ego_motion: false
    exclude_ground: false
  loss:
    temperature: 0.1


